<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Threats WebSocket Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .threat-item {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .threat-item.high {
            background: #f8d7da;
            border-color: #f5c6cb;
        }
        .threat-item.medium {
            background: #fff3cd;
            border-color: #ffeaa7;
        }
        .threat-item.low {
            background: #d1ecf1;
            border-color: #bee5eb;
        }
        .threat-header {
            font-weight: bold;
            color: #495057;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .threat-severity {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
        }
        .threat-severity.high {
            background: #dc3545;
            color: white;
        }
        .threat-severity.medium {
            background: #ffc107;
            color: #212529;
        }
        .threat-severity.low {
            background: #17a2b8;
            color: white;
        }
        .threat-details {
            font-size: 14px;
            color: #6c757d;
            margin: 5px 0;
        }
        .threat-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            margin: 5px 0;
        }
        .stat-value.high {
            color: #dc3545;
        }
        .stat-value.medium {
            color: #ffc107;
        }
        .stat-value.low {
            color: #17a2b8;
        }
        .data-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 5px 0;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Threats WebSocket Test</h1>
        <div id="status" class="status disconnected">Disconnected</div>

        <h2>Threat Statistics</h2>
        <div class="threat-stats">
            <div class="stat-card">
                <div class="stat-value high" id="high-threats">0</div>
                <div>High Severity</div>
            </div>
            <div class="stat-card">
                <div class="stat-value medium" id="medium-threats">0</div>
                <div>Medium Severity</div>
            </div>
            <div class="stat-card">
                <div class="stat-value low" id="low-threats">0</div>
                <div>Low Severity</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-threats">0</div>
                <div>Total Threats</div>
            </div>
        </div>

        <h2>Active Threats</h2>
        <div id="threats-list"></div>

        <h3>Raw Data Log</h3>
        <div id="raw-data" style="max-height: 300px; overflow-y: auto;"></div>
    </div>

    <script>
        const ws = new WebSocket("ws://localhost:8000/ws/threats");
        const statusEl = document.getElementById("status");
        const threatsListEl = document.getElementById("threats-list");
        const rawDataEl = document.getElementById("raw-data");

        // Threat counters
        let threatCounts = { high: 0, medium: 0, low: 0, total: 0 };

        function updateThreatStats() {
            document.getElementById("high-threats").textContent = threatCounts.high;
            document.getElementById("medium-threats").textContent = threatCounts.medium;
            document.getElementById("low-threats").textContent = threatCounts.low;
            document.getElementById("total-threats").textContent = threatCounts.total;
        }

        function addThreatToList(threat) {
            const threatDiv = document.createElement("div");
            const severity = threat.severity || threat.risk_level || 'medium';
            threatDiv.className = `threat-item ${severity.toLowerCase()}`;

            threatDiv.innerHTML = `
                <div class="threat-header">
                    <span>${threat.type || threat.threat_type || 'Unknown Threat'}</span>
                    <span class="threat-severity ${severity.toLowerCase()}">${severity}</span>
                </div>
                <div class="threat-details"><strong>Source IP:</strong> ${threat.source_ip || threat.src_ip || 'N/A'}</div>
                <div class="threat-details"><strong>Destination IP:</strong> ${threat.dest_ip || threat.dst_ip || 'N/A'}</div>
                <div class="threat-details"><strong>Description:</strong> ${threat.description || threat.message || 'No description available'}</div>
                <div class="threat-details"><strong>Timestamp:</strong> ${threat.timestamp || new Date().toLocaleString()}</div>
                <div class="threat-details"><strong>Protocol:</strong> ${threat.protocol || 'N/A'}</div>
                ${threat.port ? `<div class="threat-details"><strong>Port:</strong> ${threat.port}</div>` : ''}
            `;

            threatsListEl.appendChild(threatDiv);

            // Update counters
            threatCounts[severity.toLowerCase()]++;
            threatCounts.total++;
            updateThreatStats();

            // Keep only last 20 threats visible
            while (threatsListEl.children.length > 20) {
                threatsListEl.removeChild(threatsListEl.firstChild);
            }
        }

        ws.onopen = function() {
            statusEl.textContent = "Connected - Monitoring for threats";
            statusEl.className = "status connected";
        };

        ws.onclose = function() {
            statusEl.textContent = "Disconnected";
            statusEl.className = "status disconnected";
        };

        ws.onerror = function(error) {
            statusEl.textContent = "Error: " + error;
            statusEl.className = "status disconnected";
        };

        ws.onmessage = function(event) {
            let data;
            try {
                data = JSON.parse(event.data);

                // Handle single threat
                if (data.type || data.threat_type || data.severity) {
                    addThreatToList(data);
                }
                // Handle array of threats
                else if (Array.isArray(data)) {
                    data.forEach(threat => {
                        addThreatToList(threat);
                    });
                }
                // Handle threats object
                else if (data.threats && Array.isArray(data.threats)) {
                    data.threats.forEach(threat => {
                        addThreatToList(threat);
                    });
                }
                // Handle detection result
                else if (data.detection_result !== undefined) {
                    if (data.detection_result === 1) {
                        addThreatToList({
                            type: 'ML Detection',
                            severity: 'high',
                            description: 'Malicious activity detected by ML model',
                            source_ip: data.src_ip || 'Unknown',
                            dest_ip: data.dst_ip || 'Unknown',
                            protocol: data.protocol || 'Unknown'
                        });
                    }
                }
            } catch {
                data = event.data;
            }

            // Add to raw data log
            const dataDiv = document.createElement("div");
            dataDiv.className = "data-item";
            dataDiv.textContent = `[${new Date().toLocaleTimeString()}] ${typeof data === 'object' ? JSON.stringify(data) : data}`;
            rawDataEl.appendChild(dataDiv);
            rawDataEl.scrollTop = rawDataEl.scrollHeight;
        };
    </script>
</body>
</html>

