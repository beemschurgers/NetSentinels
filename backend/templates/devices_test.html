<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Devices Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .device-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .device-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .device-header {
            font-weight: bold;
            color: #495057;
            margin-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 5px;
        }
        .device-info {
            font-size: 14px;
            margin: 5px 0;
        }
        .data-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 5px 0;
            font-family: monospace;
            font-size: 12px;
        }
        .scan-info, .network-stats {
            margin-top: 20px;
            padding: 15px;
            background: #e9ecef;
            border-radius: 8px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .stat-item {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            text-align: center;
        }
        .device-type-badge {
            display: inline-block;
            background: #007bff;
            color: white;
            border-radius: 12px;
            padding: 5px 10px;
            margin: 5px 0;
            font-size: 12px;
        }
        /* Color coding for device types */
        .device-card.router {
            border-left: 5px solid #007bff;
        }
        .device-card.server {
            border-left: 5px solid #28a745;
        }
        .device-card.iot {
            border-left: 5px solid #17a2b8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Network Devices WebSocket Test</h1>
        <div id="status" class="status disconnected">Disconnected</div>

        <h2>Connected Devices</h2>
        <div id="device-count">Devices found: 0</div>
        <div id="devices-grid" class="device-grid"></div>

        <h3>Raw Data Log</h3>
        <div id="raw-data" style="max-height: 300px; overflow-y: auto;"></div>
    </div>

    <script>
        const ws = new WebSocket("ws://localhost:8000/ws/devices");
        const statusEl = document.getElementById("status");
        const devicesGrid = document.getElementById("devices-grid");
        const deviceCountEl = document.getElementById("device-count");
        const rawDataEl = document.getElementById("raw-data");

        ws.onopen = function() {
            statusEl.textContent = "Connected";
            statusEl.className = "status connected";
        };

        ws.onclose = function() {
            statusEl.textContent = "Disconnected";
            statusEl.className = "status disconnected";
        };

        ws.onerror = function(error) {
            statusEl.textContent = "Error: " + error;
            statusEl.className = "status disconnected";
        };

        ws.onmessage = function(event) {
            let data;
            try {
                data = JSON.parse(event.data);

                // Handle the devices array from network scanning
                if (data.devices && Array.isArray(data.devices)) {
                    devicesGrid.innerHTML = "";
                    deviceCountEl.textContent = `Devices found: ${data.devices.length}`;

                    data.devices.forEach(device => {
                        const deviceCard = document.createElement("div");
                        deviceCard.className = "device-card";

                        // Color code by device type
                        let cardClass = "device-card";
                        if (device.device_type === "Router") cardClass += " router";
                        else if (device.device_type === "Server") cardClass += " server";
                        else if (device.device_type === "IoT Device") cardClass += " iot";

                        deviceCard.className = cardClass;
                        deviceCard.innerHTML = `
                            <div class="device-header">${device.hostname}</div>
                            <div class="device-info"><strong>IP:</strong> ${device.ip_address}</div>
                            <div class="device-info"><strong>MAC:</strong> ${device.mac_address}</div>
                            <div class="device-info"><strong>Type:</strong> ${device.device_type}</div>
                            <div class="device-info"><strong>OS:</strong> ${device.os}</div>
                            <div class="device-info"><strong>Status:</strong>
                                <span class="status-${device.status}">${device.status}</span>
                            </div>
                            <div class="device-info"><strong>Subnet:</strong> ${device.subnet}</div>
                            <div class="device-info"><strong>Interface:</strong> ${device.interface}</div>
                            <div class="device-info"><strong>Open Ports:</strong> ${device.open_ports}</div>
                            <div class="device-info"><strong>Risk Level:</strong>
                                <span class="risk-${device.risk_level.toLowerCase()}">${device.risk_level}</span>
                            </div>
                            <div class="device-info"><strong>CPU Usage:</strong> ${device.cpu_usage}%</div>
                            <div class="device-info"><strong>Memory Usage:</strong> ${device.memory_usage}%</div>
                            <div class="device-info"><strong>Last Seen:</strong> ${device.last_seen}</div>
                            <div class="device-info"><strong>Discovery:</strong> ${device.discovery_method}</div>
                        `;
                        devicesGrid.appendChild(deviceCard);
                    });

                    // Update scan information if available
                    if (data.scan_info) {
                        updateScanInfo(data.scan_info);
                    }

                    // Update statistics if available
                    if (data.statistics) {
                        updateStatistics(data.statistics);
                    }
                }

                // Handle status messages
                else if (data.status) {
                    const statusDiv = document.createElement("div");
                    statusDiv.className = "scan-status";
                    statusDiv.textContent = `${data.status}: ${data.message}`;
                    devicesGrid.appendChild(statusDiv);
                }

                // Fallback for old data structure
                else if (data.device) {
                    const device = data.device;
                    const deviceCard = document.createElement("div");
                    deviceCard.className = "device-card";
                    deviceCard.innerHTML = `
                        <div class="device-header">${device.hostname || 'Unknown Device'}</div>
                        <div class="device-info"><strong>IP:</strong> ${device.ip_address || 'N/A'}</div>
                        <div class="device-info"><strong>Type:</strong> ${device.device_type || 'N/A'}</div>
                        <div class="device-info"><strong>Status:</strong> ${device.status || 'Unknown'}</div>
                    `;
                    devicesGrid.appendChild(deviceCard);
                }
            } catch (e) {
                console.error("Error parsing device data:", e);
                data = event.data;
            }

            // Add to raw data log
            const dataDiv = document.createElement("div");
            dataDiv.className = "data-item";
            dataDiv.textContent = `[${new Date().toLocaleTimeString()}] ${typeof data === 'object' ? JSON.stringify(data, null, 2) : data}`;
            rawDataEl.appendChild(dataDiv);
            rawDataEl.scrollTop = rawDataEl.scrollHeight;

            // Limit raw data entries
            while (rawDataEl.children.length > 20) {
                rawDataEl.removeChild(rawDataEl.firstChild);
            }
        };

        function updateScanInfo(scanInfo) {
            // Create or update scan info section
            let scanInfoEl = document.getElementById("scan-info");
            if (!scanInfoEl) {
                scanInfoEl = document.createElement("div");
                scanInfoEl.id = "scan-info";
                scanInfoEl.className = "scan-info";
                deviceCountEl.parentNode.insertBefore(scanInfoEl, deviceCountEl.nextSibling);
            }

            scanInfoEl.innerHTML = `
                <h3>Scan Information</h3>
                <div><strong>Last Scan:</strong> ${scanInfo.last_scan}</div>
                <div><strong>Total Discovered:</strong> ${scanInfo.total_discovered}</div>
                <div><strong>Scanning Status:</strong> ${scanInfo.scanning ? 'Active' : 'Idle'}</div>
            `;
        }

        function updateStatistics(stats) {
            // Create or update statistics section
            let statsEl = document.getElementById("network-stats");
            if (!statsEl) {
                statsEl = document.createElement("div");
                statsEl.id = "network-stats";
                statsEl.className = "network-stats";
                devicesGrid.parentNode.insertBefore(statsEl, devicesGrid);
            }

            statsEl.innerHTML = `
                <h3>Network Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value">${stats.total_devices}</div>
                        <div class="stat-label">Total Devices</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${stats.online_devices}</div>
                        <div class="stat-label">Online</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${stats.high_risk_devices}</div>
                        <div class="stat-label">High Risk</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${stats.security_score.toFixed(0)}</div>
                        <div class="stat-label">Security Score</div>
                    </div>
                </div>
                <div class="device-types">
                    <h4>Device Types:</h4>
                    ${Object.entries(stats.device_types).map(([type, count]) =>
                        `<span class="device-type-badge">${type}: ${count}</span>`
                    ).join(' ')}
                </div>
            `;
        }
    </script>
</body>
</html>
